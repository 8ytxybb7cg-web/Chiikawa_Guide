<!DOCTYPE html>
<html lang="zh-Hk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chiikawaè²©å”®</title>
  
  <link rel="icon" href="https://i.postimg.cc/3R7nNT0k/icon.png" type="image/png" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
/* ================= åŸºç¤æ¨£å¼ ================= */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: #f9f9f9;
  margin: 0;
  padding: 0;
  color: #333333;
  text-align: center;
  -webkit-font-smoothing: antialiased;
}

/* ================= é ‚éƒ¨é€šçŸ¥æ¢ (æ”¹ç‚ºç®¡ç†å“¡ç™»å…¥) ================= */
.top-bar {
  background: var(--tab-color);
  color: #fff;
  height: 44px; /* iOS standard height */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: flex-end; /* åœ–ç¤ºé å³ */
  padding: 0 16px;
  box-sizing: border-box;
  transition: background 0.3s;
}

/* ç®¡ç†å“¡åœ–ç¤º (iOS é¢¨æ ¼) */
.admin-icon {
  width: 24px;
  height: 24px;
  cursor: pointer;
  fill: #fff;
  opacity: 0.9;
  transition: opacity 0.2s;
}
.admin-icon:active { opacity: 0.5; }

/* ================= å°èˆªåˆ— ================= */
.nav-bar-wrapper {
  position: fixed;
  top: 44px; /* é…åˆ top-bar é«˜åº¦ */
  width: 100%;
  background: rgba(249, 249, 249, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  z-index: 998;
  padding: 0 5px;
  box-sizing: border-box;
  height: 40px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.nav-bar-scroll {
  flex: 1;
  overflow-x: auto;
  white-space: nowrap;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.nav-bar-scroll::-webkit-scrollbar { display: none; }

.nav-bar {
  display: inline-block;
  white-space: nowrap;
  padding: 0;
  font-size: 14px;
  color: #333;
}
.nav-bar a {
  color: #666;
  text-decoration: none;
  margin: 0 8px;
  display: inline-block;
  font-weight: 500;
  padding: 10px 4px;
  position: relative;
}
.nav-bar a.active {
  color: var(--tab-color, #333);
  font-weight: 700;
}
.nav-arrow {
  width: 32px;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #999;
  cursor: pointer;
  user-select: none;
}

/* ================= å•†å“å±•ç¤ºå€ ================= */
#card-container {
  padding: 90px 10px 20px 10px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 1200px;
  margin: 0 auto;
}

/* åˆ†é¡æ¨™é¡Œ */
.type-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 16px 0 8px 0;
  color: #333;
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 0.5px;
}
.type-divider::before,
.type-divider::after {
  content: "";
  flex: 1;
  border-top: 1px solid #e0e0e0;
  margin: 0 12px;
}

.group-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 10px;
  justify-items: center;
}

/* ================= å•†å“å¡ç‰‡ ================= */
.card {
  width: 100%;
  max-width: 130px;
  border: 1px solid #eee;
  border-radius: 12px;
  background-color: #fff;
  position: relative;
  text-align: center;
  padding-bottom: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  transition: transform 0.2s, box-shadow 0.2s;
  overflow: hidden;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.card:active { transform: scale(0.98); }

.card img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: contain;
  padding: 8px;
  box-sizing: border-box;
}

.card .name {
  margin: 4px 6px;
  font-size: 12px;
  font-weight: 600;
  line-height: 1.4;
  color: #333;
  min-height: 32px; /* ä¿æŒé«˜åº¦ä¸€è‡´ */
  display: flex;
  align-items: center;
  justify-content: center;
}
.card .price {
  font-size: 13px;
  color: #666;
  font-family: "SF Pro Text", sans-serif;
  margin-bottom: 6px;
}

/* ç‹€æ…‹æ¨™ç±¤ */
.status-badge {
  display: inline-block;
  border-radius: 20px;
  padding: 3px 8px;
  font-size: 11px;
  font-weight: 600;
  margin: 0 auto 6px auto;
  letter-spacing: 0.5px;
}

/* ç®¡ç†å“¡æ¨¡å¼ä¸‹çš„ Select */
.admin-select {
  appearance: none;
  -webkit-appearance: none;
  border: none;
  border-radius: 20px;
  padding: 3px 20px 3px 10px; /* é ç•™ç®­é ­ç©ºé–“ */
  font-size: 11px;
  font-weight: bold;
  margin: 0 auto 6px auto;
  text-align: center;
  text-align-last: center;
  cursor: pointer;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 4px center;
  background-size: 10px;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}
.admin-select:focus { outline: none; box-shadow: 0 0 0 2px var(--tab-color); }

/* è§’è‰²åœ“æ¨™ */
.role-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  color: #fff;
  font-size: 10px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ================= Modal (ç™»å…¥ & çµ„åˆ) ================= */
.modal {
  display: none; 
  position: fixed; 
  z-index: 10000; 
  left: 0; top: 0; width: 100%; height: 100%; 
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-content {
  background-color: #fff;
  margin: 20% auto;
  padding: 24px;
  width: 80%;
  max-width: 320px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  animation: modalUp 0.3s ease-out;
}
@keyframes modalUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-sizing: border-box;
  font-size: 16px;
  outline: none;
  background: #f5f5f5;
}
.login-input:focus { background: #fff; border-color: var(--tab-color); }
.login-btn {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  background: var(--tab-color);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}
.close-modal-btn {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 24px; color: #aaa; cursor: pointer;
}

/* ================= æ”¾å¤§æª¢è¦– (Overlay) ================= */
#cardOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 11000;
}
#cardOverlay .card {
  width: auto !important;
  max-width: 85vw !important;
  transform: none !important;
  cursor: default !important;
  padding: 24px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.2);
}
#cardOverlay img { max-height: 50vh; width: auto !important; }
#cardOverlay .name { font-size: 1.5em !important; margin: 16px 0; }
#cardOverlay .price { font-size: 1.4em !important; color: #333; font-weight: bold; }
#cardOverlay .status-badge { font-size: 1.2em !important; padding: 6px 16px !important; }
#cardOverlay .role-badge { display: none !important; }
.admin-only { display: none; } /* é è¨­éš±è—ç®¡ç†ä»‹é¢ */

  </style>
</head>
<body>

  <div class="top-bar">
    <svg class="admin-icon" onclick="openLoginModal()" viewBox="0 0 24 24">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
  </div>

  <div id="card-container"></div>
  
  <div class="nav-bar-wrapper">
    <div class="nav-arrow nav-left">â®</div>
    <div class="nav-bar-scroll">
      <div class="nav-bar">
        <a class="nav-link" href="#åŠå¨ƒã€å¨ƒ">åŠå¨ƒï¼å¨ƒ</a>
        <a class="nav-link" href="#åŒ…è¢‹">åŒ…è¢‹</a>
        <a class="nav-link" href="#è­‰ä»¶å¥—">è­‰ä»¶å¥—</a>
        <a class="nav-link" href="#é‘°åŒ™åœˆ">é‘°åŒ™åœˆ</a>
        <a class="nav-link" href="#å¾¡å®ˆç¹ªé¦¬">å¾¡å®ˆç¹ªé¦¬</a>
        <a class="nav-link" href="#æ–‡å…·ç£éµ">æ–‡å…·ç£éµ</a>
        <a class="nav-link" href="#è²¼ç´™">è²¼ç´™</a>
        <a class="nav-link" href="#ç«‹ç‰Œå¾½ç« ">ç«‹ç‰Œå¾½ç« </a>
        <a class="nav-link" href="#ç©å…·ç›²æŠ½">ç©å…·ç›²æŠ½</a>
        <a class="nav-link" href="#3Cé…ä»¶">3Cé…ä»¶</a>
        <a class="nav-link" href="#ç”Ÿæ´»å±…å®¶">ç”Ÿæ´»å±…å®¶</a>
        <a class="nav-link" href="#æœé£¾é…ä»¶">æœé£¾é…ä»¶</a>
        <a class="nav-link" href="#é¤å»š">é¤å»š</a>
      </div>
    </div>
    <div class="nav-arrow nav-right">â¯</div>
  </div>
  
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-modal-btn" onclick="document.getElementById('loginModal').style.display='none'">&times;</span>
      <h3 style="margin-top:0;">ç®¡ç†å“¡ç™»å…¥</h3>
      <input type="text" id="adminId" class="login-input" placeholder="ID">
      <input type="password" id="adminPwd" class="login-input" placeholder="Password">
      <button class="login-btn" onclick="handleLogin()">ç™»å…¥</button>
    </div>
  </div>

  <div id="comboModal" class="modal">
    <div class="modal-content" style="max-width: 500px; text-align: left;">
      <span class="close-modal-btn" onclick="document.getElementById('comboModal').style.display='none'">&times;</span>
      <h2 id="comboTitle" style="margin-top:0; font-size:18px;">çµ„åˆå…§å®¹</h2>
      <div id="comboBody">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div id="cardOverlay"></div>

<script>
// ================= Supabase è¨­å®š =================
const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi'; // æ³¨æ„ï¼šæ­¤ Key æš´éœ²åœ¨å‰ç«¯
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= å…¨åŸŸè®Šæ•¸ =================
const SHEET_ID  = "1iCEqgnGGa_TVVbx90xNWxDzwKtz94VfqF8IsXRvpKMY";
const sheetName = "ã¡ã„ã‹ã‚";

const roleMap = { "å‰ä¼Š":"å‰","å°å…«":"å…«","å…”å…”":"å…”","å°æ¡ƒ":"æ¡ƒ","å¸«å‚…":"çº",
                  "æ —å­":"æ —","ç…è–©":"ç…","å¤æœ¬":"å¤","å…¶ä»–è§’è‰²":"å…¶" };
const colors  = { "å‰ä¼Š":"#d77485","å°å…«":"#6293b8","å…”å…”":"#f9be3c","å°æ¡ƒ":"#838BC2",
                  "å¸«å‚…":"#CCAFA5","æ —å­":"#94C973","ç…è–©":"#FBAA60","å¤æœ¬":"#eb9e97",
                  "å…¶ä»–è§’è‰²":"#45818e" };
const categoryMap = {
  "åŠå¨ƒ":"åŠå¨ƒã€å¨ƒ","å¨ƒ":"åŠå¨ƒã€å¨ƒ",
  "åŒ…åŒ…":"åŒ…è¢‹","è­‰ä»¶å¥—":"è­‰ä»¶å¥—",
  "æ–‡å…·":"æ–‡å…·ç£éµ","ç£éµ":"æ–‡å…·ç£éµ",
  "è²¼ç´™":"è²¼ç´™","é‘°åŒ™åœˆ":"é‘°åŒ™åœˆ",
  "å¾¡å®ˆ":"å¾¡å®ˆç¹ªé¦¬","ç«‹ç‰Œ":"ç«‹ç‰Œå¾½ç« ","å¾½ç« ":"ç«‹ç‰Œå¾½ç« ",
  "ç©å…·":"ç©å…·ç›²æŠ½","ç›²":"ç©å…·ç›²æŠ½",
  "3C":"3Cé…ä»¶","å±…å®¶":"ç”Ÿæ´»å±…å®¶","æ¯›å·¾":"ç”Ÿæ´»å±…å®¶",
  "è¡£æœ":"æœé£¾é…ä»¶","é£¾å“":"æœé£¾é…ä»¶","é¤å»š":"é¤å»š"
};
const categoryOrder = [
  "åŠå¨ƒã€å¨ƒ","åŒ…è¢‹","è­‰ä»¶å¥—","é‘°åŒ™åœˆ","å¾¡å®ˆç¹ªé¦¬","æ–‡å…·ç£éµ","è²¼ç´™",
  "ç«‹ç‰Œå¾½ç« ","ç©å…·ç›²æŠ½","3Cé…ä»¶","ç”Ÿæ´»å±…å®¶","æœé£¾é…ä»¶","é¤å»š","æœªåˆ†é¡"
];
const extraStyleCategoryMap = {
  "é‘°åŒ™åŒ…":"åŒ…è¢‹","å¨ƒå¤¾å­":"æ–‡å…·ç£éµ",
  "æ–œèƒŒåŒ…":"åŒ…è¢‹","å¨ƒå¾½ç« ":"ç«‹ç‰Œå¾½ç« ","æŠ±æ•":"ç”Ÿæ´»å±…å®¶"
};

let isAdmin = false;
let globalItems = []; // å„²å­˜è™•ç†å¾Œçš„è³‡æ–™
let currentRole = "å‰ä¼Š";
let supabaseOverrides = {}; // å„²å­˜ä¾†è‡ª Supabase çš„ç‹€æ…‹è¦†è“‹ { "å•†å“å": "ç¾è²¨" }

// ================= ç™»å…¥é‚è¼¯ =================
function openLoginModal() {
  document.getElementById("loginModal").style.display = "block";
}

function handleLogin() {
  const id = document.getElementById("adminId").value;
  const pwd = document.getElementById("adminPwd").value;
  if (id === "1050267" && pwd === "Penny01!") {
    isAdmin = true;
    document.getElementById("loginModal").style.display = "none";
    alert("ç™»å…¥æˆåŠŸï¼æ‚¨å¯ä»¥æ›´æ”¹å¡ç‰‡ç‹€æ…‹äº† (ï½¡â€¢Ì€á´—-)âœ§");
    renderCards(globalItems, currentRole); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç®¡ç†ä»‹é¢
  } else {
    alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ ğŸ™…â€â™‚ï¸");
  }
}

// ================= è¼‰å…¥è³‡æ–™ (Sheet + Supabase) =================
function getRoleFromURL(){
  const p = new URLSearchParams(location.search).get("role");
  return roleMap[p] ? p : "å‰ä¼Š";
}

async function loadSheetData(){
  currentRole = getRoleFromURL();
  document.documentElement.style.setProperty("--tab-color", colors[currentRole]||"#999");
  
  try {
    // 1. å¹³è¡Œè¼‰å…¥ Google Sheet å’Œ Supabase è³‡æ–™
    const [sheetRes, supabaseRes] = await Promise.all([
      fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`)
        .then(r => r.text()),
      supabase.from('chiikawa_data').select('item_name, status')
    ]);

    // 2. è™•ç† Supabase è³‡æ–™
    if(supabaseRes.data) {
      supabaseRes.data.forEach(row => {
        supabaseOverrides[row.item_name] = row.status;
      });
    }

    // 3. è™•ç† Google Sheet è³‡æ–™
    const jsonText = sheetRes.substr(47).slice(0, -2);
    const data = JSON.parse(jsonText);
    const rows = data.table.rows || [];
    const keyword = roleMap[currentRole];

    globalItems = rows.map((row, i) => {
      const rawPrice = row.c[5]?.v;
      let finalPrice = rawPrice;
      
      // === åƒ¹æ ¼è¨ˆç®—é‚è¼¯ ===
      // é™¤ä»¥ 3.8ï¼Œè‹¥é 0 æˆ– 5 çµå°¾å‰‡å‘ä¸Šèª¿æ•´
      if (typeof rawPrice === 'number') {
        const divided = rawPrice / 3.8;
        // å…¬å¼ï¼šMath.ceil(å€¼ / 5) * 5
        finalPrice = Math.ceil(divided / 5) * 5;
      } else if (rawPrice === "-") {
        finalPrice = "-"; // çµ„åˆå•†å“
      } else {
        // å¦‚æœæ˜¯æ–‡å­—æˆ–ç©ºå€¼ï¼Œä¿æŒåŸæ¨£ (é€šå¸¸æ˜¯ç§è¨ŠèŠ±èŠ±)
        finalPrice = rawPrice;
      }

      const item = {
        index: i,
        role: row.c[0]?.v || "",
        rawType: row.c[1]?.v || "",
        style: row.c[2]?.v || "",
        name: row.c[3]?.v || "",
        price: finalPrice, // ä½¿ç”¨è¨ˆç®—å¾Œçš„åƒ¹æ ¼
        img: row.c[11]?.v || "https://i.postimg.cc/bv5xRs04/image.png"
      };

      // åˆ†é¡åˆ¤å®š
      item.category = (item.style === "è­‰ä»¶å¥—") ? "è­‰ä»¶å¥—" : 
                      (categoryMap[item.rawType] || categoryMap[item.style] || item.rawType || "æœªåˆ†é¡");

      // === ç‹€æ…‹åˆ¤å®šé‚è¼¯ ===
      // å„ªå…ˆé †åºï¼šSupabaseè¦†è“‹ > åˆ†é¡è¦å‰‡ (åŠå¨ƒ/å¨ƒ=ç¾è²¨, å…¶ä»–=éœ€é è¨‚)
      // èˆŠæœ‰çš„ Sheet Stock æ¬„ä½åœ¨æ­¤é‚è¼¯ä¸‹è¢«å¿½ç•¥ï¼Œé™¤ééœ€è¦ fallback (ç›®å‰ä¾éœ€æ±‚ç›´æ¥å…¨è¦†è“‹)
      
      let computedStatus = "éœ€é è¨‚"; // é è¨­
      if (item.category === "åŠå¨ƒã€å¨ƒ") {
        computedStatus = "ç¾è²¨";
      }

      // å¦‚æœæœ‰ Supabase ç´€éŒ„ï¼Œè¦†è“‹ç‹€æ…‹
      if (supabaseOverrides[item.name]) {
        computedStatus = supabaseOverrides[item.name];
      }
      
      item.status = computedStatus;

      return item;
    })
    .filter(it => it.role.includes(keyword));

    renderCards(globalItems, currentRole);

  } catch (error) {
    console.error(error);
    document.getElementById("card-container").textContent = "è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
  }
}

// ================= ç®¡ç†å“¡æ›´æ–°ç‹€æ…‹ =================
async function updateStatus(itemName, newStatus) {
  if (!itemName) return;
  
  // 1. æ›´æ–°æœ¬åœ°è³‡æ–™ (è®“ UI ç«‹å³åæ‡‰)
  supabaseOverrides[itemName] = newStatus;
  const item = globalItems.find(i => i.name === itemName);
  if (item) item.status = newStatus;

  // 2. æ›´æ–° UI é¡è‰²
  renderCards(globalItems, currentRole); // ç°¡å–®æš´åŠ›é‡ç¹ªï¼Œç¢ºä¿ä¸€è‡´æ€§

  // 3. å¯«å…¥ Supabase
  const { error } = await supabase
    .from('chiikawa_data')
    .upsert({ item_name: itemName, status: newStatus }, { onConflict: 'item_name' });
  
  if (error) {
    alert("å„²å­˜å¤±æ•—: " + error.message);
  }
}

// ================= ç•«é¢æ¸²æŸ“ =================
function renderCards(items, roleName){
  const container = document.getElementById("card-container");
  container.innerHTML = "";
  
  // åˆ†çµ„é‚è¼¯
  const grouped = {};
  items.forEach(it => {
    (grouped[it.category] = grouped[it.category] || []).push(it);
    // è™•ç†é¡å¤–åˆ†é¡æ˜ å°„ (å¦‚å°‡é‘°åŒ™åŒ…ä¹Ÿé¡¯ç¤ºåœ¨åŒ…è¢‹å€)
    if(it.category === "åŠå¨ƒã€å¨ƒ"){
      const tgt = extraStyleCategoryMap[it.style];
      if(tgt) (grouped[tgt] = grouped[tgt] || []).push({...it});
    }
  });

  const styleOrder = [];
  items.forEach(it => { if(!styleOrder.includes(it.style)) styleOrder.push(it.style); });

  categoryOrder.forEach(cat => {
    const list = grouped[cat];
    if(!list || !list.length) return;

    // æ¸²æŸ“åˆ†é¡æ¨™é¡Œ
    const div = document.createElement("div");
    div.className = "type-divider";
    div.id = cat;
    div.style.scrollMarginTop = "90px";
    div.textContent = cat;
    container.appendChild(div);

    // Grid å®¹å™¨
    const gdiv = document.createElement("div");
    gdiv.className = "group-grid";
    
    // ä¾æ¬¾å¼æ’åº
    const byStyle = {};
    list.forEach(it => (byStyle[it.style] = byStyle[it.style] || []).push(it));

    styleOrder.forEach(sty => {
      const arr = byStyle[sty];
      if(!arr) return;
      arr.sort((a,b) => a.index - b.index).forEach(item => {
        
        // ç‹€æ…‹é¡è‰²è¨­å®š
        const statusConfig = getStatusConfig(item.status);

        const single = "å‰å…«å…”æ¡ƒçºæ —ç…å¤å…¶";
        const ch = item.role.match(/[\u4e00-\u9fff]/g) || [];
        const rtxt = (ch.length === 1 && single.includes(ch[0])) ? ch[0] : "ç¶œ";

        const isCombo = item.price === "-";
        const needLineLink = !item.price || item.price === "ç§è¨ŠèŠ±èŠ±";

        const cardTag = "div";
        const card = document.createElement(cardTag);
        card.className = "card";
        card.style.borderColor = "#eee"; // çµ±ä¸€æ·¡é‚Šæ¡†

        // é»æ“Šäº‹ä»¶
        if (isCombo) {
          card.onclick = () => loadComboDetails(item.name);
        } else if (needLineLink) {
           // ç§è¨Šå•†å“ä¸å½ˆçª—ï¼Œç›´æ¥å» Line (æˆ–ä¿ç•™å½ˆçª—ç”±ä½¿ç”¨è€…æ±ºå®šï¼Œé€™è£¡ç…§èˆŠé‚è¼¯å»å½ˆçª—è¼ƒç¾è§€)
           card.onclick = () => openCardOverlay(card.cloneNode(true), item);
        } else {
           card.onclick = () => openCardOverlay(card.cloneNode(true), item);
        }

        // ç‹€æ…‹ HTML (æ™®é€šæ¨¡å¼ vs ç®¡ç†å“¡æ¨¡å¼)
        let statusHtml = "";
        if (isAdmin) {
          // ç®¡ç†å“¡ä¸‹æ‹‰é¸å–®
          statusHtml = `
            <select class="admin-select" 
              style="background-color:${statusConfig.bg}; color:${statusConfig.color}"
              onclick="event.stopPropagation()"
              onchange="updateStatus('${item.name}', this.value)">
              <option value="éœ€é è¨‚" ${item.status==="éœ€é è¨‚"?"selected":""}>éœ€é è¨‚</option>
              <option value="ç¾è²¨" ${item.status==="ç¾è²¨"?"selected":""}>ç¾è²¨</option>
              <option value="é»è²¨ä¸­" ${item.status==="é»è²¨ä¸­"?"selected":""}>é»è²¨ä¸­</option>
            </select>
          `;
        } else {
          // ä¸€èˆ¬é¡¯ç¤º
          statusHtml = `
            <div class="status-badge" style="background:${statusConfig.bg}; color:${statusConfig.color}">
              ${item.status}
            </div>
          `;
        }

        // è§’è‰²æ¨™ç±¤ (éåŠå¨ƒå€é¡¯ç¤º)
        const roleBadge = (cat !== "åŠå¨ƒã€å¨ƒ") 
          ? `<div class="role-badge" style="background-color:${rtxt==="ç¶œ"?"#dac7b7":colors[roleName]||"#ccc"}">${rtxt}</div>` 
          : "";

        card.innerHTML = `
          ${roleBadge}
          <img src="${item.img}" alt="${item.name}" loading="lazy">
          ${statusHtml}
          <div class="name">${formatName(item.name)}</div>
          <div class="price">${formatPrice(item.price)}</div>
        `;
        gdiv.appendChild(card);
      });
    });
    container.appendChild(gdiv);
  });
}

function getStatusConfig(statusText) {
  switch(statusText) {
    case "ç¾è²¨": return { bg: "#FFF4BD", color: "#333" };
    case "éœ€é è¨‚": return { bg: "#D4BBDD", color: "#333" };
    case "é»è²¨ä¸­": return { bg: "#E7F2F8", color: "#333" };
    case "å—æ³¨å“": return { bg: "#74BDCB", color: "#fff" };
    case "æ­é£›æ©Ÿä¸­": return { bg: "#5885AF", color: "#fff" };
    default: return { bg: "#eee", color: "#999" };
  }
}

// ================= è¼”åŠ©å‡½å¼ =================
function formatName(name){
  if(!name) return "";
  const cleanName = name.trim();
  if(cleanName.length <= 9) return cleanName;
  const spaceIndex = cleanName.lastIndexOf(" ", 9);
  if(spaceIndex > 0) return cleanName.slice(0, spaceIndex) + "<br>" + cleanName.slice(spaceIndex+1);
  return cleanName.slice(0, 9) + "<br>" + cleanName.slice(9);
}

function formatPrice(price){
  if(price === "-" || price === "çµ„åˆå‡ºå”®") return "çµ„åˆå‡ºå”®";
  if(!price || price === "ç§è¨ŠèŠ±èŠ±") return "ç§è¨ŠèŠ±èŠ±";
  return `$${price}`;
}

// ================= Modal çµ„åˆå…§å®¹é‚è¼¯ (ä¿ç•™åŸåŠŸèƒ½) =================
function loadComboDetails(clickedItemName) {
  const modal = document.getElementById("comboModal");
  const body = document.getElementById("comboBody");
  document.getElementById("comboTitle").textContent = clickedItemName;
  body.innerHTML = "è¼‰å…¥ä¸­...";
  modal.style.display = "block";

  fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=çµ„åˆå‡ºå”®å€`)
    .then(r => r.text())
    .then(t => JSON.parse(t.substr(47).slice(0, -2)))
    .then(data => {
      const rows = data.table.rows || [];
      const currentRoleFull = getRoleFromURL(); // e.g., "å‰ä¼Š"
      const currentRoleKey = roleMap[currentRoleFull] || ""; 
      const targetItem = clickedItemName.trim();
      
      let lastRole = "", lastItem = "";
      const filteredRows = rows.filter(row => {
        const roleField = (row.c[1]?.v || lastRole).trim();
        const itemField = (row.c[2]?.v || lastItem).trim();
        if (row.c[1]?.v) lastRole = row.c[1].v;
        if (row.c[2]?.v) lastItem = row.c[2].v;
        return roleField.includes(currentRoleKey) && itemField === targetItem;
      });

      if (!filteredRows.length) {
        body.innerHTML = "ğŸš€ çµ„åˆå…§å®¹æ•´ç†ä¸­... å¯ä»¥å…ˆç§è¨ŠèŠ±èŠ±è©¢å•ï¼";
        return;
      }

      // çµ„åˆæ¸²æŸ“é‚è¼¯ (ç°¡åŒ–ç‰ˆï¼Œä¿ç•™æ ¸å¿ƒçµæ§‹)
      const grouped = {};
      filteredRows.forEach(row => {
        const gName = (row.c[3]?.v || "").trim();
        (grouped[gName] = grouped[gName] || []).push(row);
      });
      
      let html = "";
      Object.keys(grouped).forEach((gName, idx) => {
        const items = grouped[gName];
        const price = items[0].c[4]?.v;
        const remark = items[0].c[9]?.v;
        // è¨ˆç®—åƒ¹æ ¼ (é™¤3.8é‚è¼¯)
        let calcPrice = price;
        if(typeof price === 'number') {
            calcPrice = Math.ceil((price/3.8)/5)*5;
        }

        const imgs = items.map(r => `<img src="${r.c[8]?.v||''}" style="width:60px; height:60px; object-fit:contain; border:1px solid #eee; border-radius:4px;">`).join("");
        
        html += `
          <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center; border-bottom:1px solid #eee; padding-bottom:8px;">
            <div style="flex:1;">
               <div style="font-weight:bold; font-size:14px;">${gName}</div>
               <div style="color:#666; font-size:12px;">${remark ? `<span style="background:#647C90; color:#fff; padding:1px 4px; border-radius:4px;">${remark}</span>` : ""}</div>
               <div style="color:#d77485; font-weight:bold; margin-top:2px;">${formatPrice(calcPrice)}</div>
            </div>
            <div style="display:flex; gap:2px; flex-wrap:wrap; width:130px; justify-content:flex-end;">${imgs}</div>
          </div>
        `;
      });
      body.innerHTML = html;
    })
    .catch(e => {
      console.error(e);
      body.textContent = "è³‡æ–™è®€å–éŒ¯èª¤";
    });
}

// ================= Overlay æ”¾å¤§å¡ç‰‡ =================
function openCardOverlay(clonedCard, itemData) {
  const overlay = document.getElementById("cardOverlay");
  overlay.innerHTML = "";
  
  // é‡å»ºæ”¾å¤§ç‰ˆå¡ç‰‡å…§å®¹ï¼Œç¢ºä¿æ¨£å¼æ­£ç¢º
  const cardDiv = document.createElement("div");
  cardDiv.className = "card";
  // ç§»é™¤é»æ“Šäº‹ä»¶é˜²æ­¢è¿´åœˆ
  
  const statusConfig = getStatusConfig(itemData?.status || "éœ€é è¨‚");
  
  cardDiv.innerHTML = `
    <img src="${itemData.img}" style="max-height:50vh; width:auto; display:block; margin:0 auto;">
    <div style="margin-top:16px; text-align:center;">
      <div class="status-badge" style="background:${statusConfig.bg}; color:${statusConfig.color}; font-size:16px; padding:6px 12px;">
        ${itemData.status}
      </div>
      <div class="name" style="font-size:20px; margin:8px 0;">${itemData.name}</div>
      <div class="price" style="font-size:18px; color:#d77485; font-weight:bold;">${formatPrice(itemData.price)}</div>
      ${(!itemData.price || itemData.price==="ç§è¨ŠèŠ±èŠ±") ? 
        '<a href="https://lin.ee/X6FUFI9" target="_blank" style="display:inline-block; margin-top:12px; background:#06C755; color:white; text-decoration:none; padding:8px 20px; border-radius:20px; font-weight:bold;">LINE è©¢å•</a>' : ''}
    </div>
  `;
  
  // é»æ“Šå¡ç‰‡å…§éƒ¨ä¸é—œé–‰
  cardDiv.onclick = (e) => e.stopPropagation();

  overlay.appendChild(cardDiv);
  overlay.style.display = "flex";
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.style.display = "none";
  };
}

// ================= åˆå§‹åŒ–èˆ‡äº‹ä»¶ =================
loadSheetData();

const navBarScroll = document.querySelector(".nav-bar-scroll");
document.querySelector(".nav-arrow.nav-left").onclick = () => navBarScroll.scrollBy({ left: -100, behavior: "smooth" });
document.querySelector(".nav-arrow.nav-right").onclick = () => navBarScroll.scrollBy({ left: 100, behavior: "smooth" });

// ç›£è½ Modal å¤–éƒ¨é»æ“Šé—œé–‰
window.onclick = e => {
  if (e.target.className === "modal") e.target.style.display = "none";
};

</script>
</body>
</html>
