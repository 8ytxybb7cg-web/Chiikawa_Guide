<!DOCTYPE html>
<html lang="zh-Hk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chiikawa Child Page</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* 預設 CSS 變數，實際顏色會由 JavaScript 根據角色動態注入 
       
    */
    :root { --tab-color: #d77485; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f9f9f9; 
      margin: 0; 
      padding: 0; 
      color: #333; 
      text-align: center;
      /* 確保底部有空間，避免被父層的購物車擋住 */
      padding-bottom: 80px;
      /* 修正 iframe 內的捲動行為 */
      overflow-x: hidden;
    }

    /* Loading 動畫 */
    .loading-container {
      margin-top: 100px;
      transition: opacity 0.3s;
    }
    .loading-icon {
      width: 20%; max-width: 100px; height: auto; margin-bottom: 10px;
      animation: bounce 0.8s infinite ease-in-out;
    }
    @keyframes bounce { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-10px); } 
    }

    /* Admin 面板樣式 */
    .admin-panel {
      display: none; /* 預設隱藏，由父層通知 Admin 狀態後顯示 */
      background: #fff; padding: 15px; margin: 10px;
      border: 2px dashed var(--tab-color); border-radius: 12px; text-align: left;
    }
    .admin-controls {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    .category-checkbox { margin: 5px 15px 5px 0; font-size: 14px; display: inline-flex; align-items: center; cursor: pointer; }
    
    /* 按鈕樣式 */
    .btn-save, .btn-cancel { 
      padding: 5px 15px; border-radius: 15px; border: none; 
      font-size: 12px; cursor: pointer; color: #fff; font-weight: bold; 
    }
    .btn-save { background: var(--tab-color); opacity: 0.9; }
    .btn-cancel { background: #999; margin-right: 5px; }

    /* 卡片容器與佈局 */
    #card-container { 
        max-width: 1200px; margin: 0 auto; min-height: 50vh; padding: 10px; 
    }
    .category-section { 
        margin-top: 30px; text-align: left; 
        scroll-margin-top: 70px; /* 配合父層 Sticky Nav 的高度 */
    }
    .category-title { 
      font-size: 18px; font-weight: bold; margin-bottom: 15px; 
      padding-left: 10px;
      border-left: 5px solid var(--tab-color); color: #444;
      display: flex; align-items: center; justify-content: space-between;
    }
    .group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
      justify-items: center; width: 100%;
    }

    /* 單一商品卡片 */
    .card {
      width: 100%; max-width: 130px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff; position: relative; text-align: center; padding-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      cursor: pointer; overflow: hidden;
      transition: transform 0.2s;
    }
    .card:active { transform: scale(0.98); }
    .card img { width: 100%; aspect-ratio: 1; object-fit: contain; padding: 8px; box-sizing: border-box; }
    
    .card .name { 
        margin: 4px 6px; font-size: 12px; font-weight: 600; line-height: 1.4;
        min-height: 32px; display: flex; align-items: center; justify-content: center; 
    }
    .card .price { font-size: 13px; color: var(--tab-color); font-weight: bold; margin-bottom: 6px; }
    .status-badge { display: inline-block; border-radius: 20px; padding: 3px 8px; font-size: 11px; font-weight: 600; margin-bottom: 6px; }

    /* Admin 編輯元件 */
    .admin-select { border: 1px solid #ccc; border-radius: 20px; padding: 2px 5px; font-size: 11px; margin-bottom: 5px; width: 90%; }
    .admin-price-input { width: 80%; border: 1px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; padding: 2px 0; }
    
    .bulk-wrapper { font-size: 12px; font-weight: normal; color: #666; display: flex; align-items: center; gap: 5px; }
    .bulk-select { padding: 2px 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; }

  </style>
</head>
<body>

  <div id="adminPanel" class="admin-panel">
    <div class="admin-controls">
        <span style="color: var(--tab-color); font-weight: bold;">分類顯示設定</span>
        <div>
            <button class="btn-cancel" onclick="location.reload()">取消</button>
            <button class="btn-save" onclick="handleSaveConfig()">儲存變更</button>
        </div>
    </div>
    <div id="category-toggles"></div>
  </div>

  <div id="card-container">
    <div id="loading-msg" class="loading-container">
      <img id="loading-img" src="" alt="Loading" class="loading-icon" />
      <div>資料讀取中...</div>
    </div>
  </div>

<script>
// --- Config ---
const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi'; 
const SHEET_ID  = "1iCEqgnGGa_TVVbx90xNWxDzwKtz94VfqF8IsXRvpKMY";
const SHEET_NAME = "ちいかわ";

// 初始化 Supabase 
let sbClient = (window.supabase) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

// --- 角色設定對照表 ---
// 根據 Prompt 要求，定義每個角色在 Google Sheet 的關鍵字、Supabase 的前綴、Config Key、顏色與圖片
const ROLE_CONFIGS = {
    "chii": { 
        name: "吉伊", sheetKey: "吉", sbPrefix: "吉伊", configKey: "visible_categories_chii", 
        color: "#d77485", loadImg: "https://i.postimg.cc/ncqjRJ9S/icon001.png" 
    },
    "hachi": { 
        name: "小八", sheetKey: "八", sbPrefix: "小八", configKey: "visible_categories_hachi", 
        color: "#6293b8", loadImg: "https://i.postimg.cc/Ss5kqJ3L/icon002.png" 
    },
    "usagi": { 
        name: "兔兔", sheetKey: "兔", sbPrefix: "兔兔", configKey: "visible_categories", // source 140
        color: "#f9be3c", loadImg: "https://i.postimg.cc/QdbBDJbp/icon003.png" 
    },
    "momo": { 
        name: "小桃", sheetKey: "桃", sbPrefix: "小桃", configKey: "visible_categories_others", 
        color: "#838BC2", loadImg: "https://i.postimg.cc/rwcd7PSV/icon016.png" 
    },
    "master": { 
        name: "師傅", sheetKey: "獺", sbPrefix: "師傅", configKey: "visible_categories_others", 
        color: "#CCAFA5", loadImg: "https://i.postimg.cc/y8vNtY1j/icon005.png" 
    },
    "kuri": { 
        name: "栗子", sheetKey: "栗", sbPrefix: "栗子", configKey: "visible_categories_kuri", // source 140
        color: "#94C973", loadImg: "https://i.postimg.cc/mD0kjXLG/icon006.png" 
    },
    "shisa": { 
        name: "風獅", sheetKey: "獅", sbPrefix: "風獅", configKey: "visible_categories_shisa", // source 140
        color: "#FBAA60", loadImg: "https://i.postimg.cc/Ghn9s5gF/icon007.png" 
    },
    "furu": { 
        name: "古本", sheetKey: "古", sbPrefix: "古本", configKey: "visible_categories_others", 
        color: "#eb9e97", loadImg: "https://i.postimg.cc/2jsL76yB/icon008.png" 
    },
    "others": { 
        name: "其他", sheetKey: "其", sbPrefix: "其他", configKey: "visible_categories_others", 
        color: "#45818e", loadImg: "https://i.postimg.cc/PqVPpf0J/icon009.png" 
    }
};

// --- 全域變數 ---
let currentRole = "chii"; // 預設
let currentConfig = ROLE_CONFIGS["chii"];
let isAdmin = false; 
let globalItems = [], allCategories = [], visibleCategories = ["吊娃", "娃"];
let supabaseOverrides = {}, pendingChanges = {};

// --- 初始化程序 ---
function init() {
    // 1. 取得網址參數中的 role
    const urlParams = new URLSearchParams(window.location.search);
    const roleParam = urlParams.get('role');

    if (roleParam && ROLE_CONFIGS[roleParam]) {
        currentRole = roleParam;
        currentConfig = ROLE_CONFIGS[roleParam];
    }

    // 2. 套用該角色的視覺設定
    document.documentElement.style.setProperty('--tab-color', currentConfig.color);
    document.getElementById("loading-img").src = currentConfig.loadImg;

    // 3. 開始載入資料
    loadData();

    // 4. 通知父層：子頁面已準備好，請告訴我 Admin 狀態
    window.parent.postMessage({ type: 'childReady' }, '*');
}

// --- 接收父層訊息 (Admin 狀態 / 滾動請求) ---
window.addEventListener('message', function(e) {
    if (!e.data) return;

    // 接收 Admin 狀態
    if (e.data.type === 'adminState') {
        isAdmin = e.data.isAdmin;
        toggleAdminUI();
        renderCards(); // 重新渲染以顯示/隱藏編輯框
    }

    // 接收滾動請求 (點擊父層分類列時)
    if (e.data.type === 'scrollTo') {
        const el = document.getElementById(`cat-${e.data.category}`);
        if (el) {
            // 計算捲動位置，扣除 header 高度
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
});

function toggleAdminUI() {
    const panel = document.getElementById("adminPanel");
    panel.style.display = isAdmin ? "block" : "none";
    if (isAdmin) renderAdminToggles();
}

// --- 核心資料載入邏輯 ---
async function loadData() {
    try {
        supabaseOverrides = {};
        
        // A. 讀取 Supabase (Config & Overrides) 
        if (sbClient) {
            // 讀取分類顯示設定
            const { data: config } = await sbClient.from('chiikawa_config')
                .select('config_value')
                .eq('config_key', currentConfig.configKey) // 使用動態 Key
                .single();
            
            if (config && config.config_value) {
                visibleCategories = Array.isArray(config.config_value) ? config.config_value : JSON.parse(config.config_value);
            }

            // 讀取所有商品覆蓋資料
            const { data: items } = await sbClient.from('chiikawa_data').select('*');
            items?.forEach(row => { supabaseOverrides[row.item_name] = row; });
        }

        // B. 讀取 Google Sheet 
        const sheetRes = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx:out:json&sheet=${SHEET_NAME}`).then(r => r.text());
        const json = JSON.parse(sheetRes.substr(47).slice(0, -2));
        const rows = json.table.rows || [];

        // C. 資料篩選與合併 
        const tempCats = new Set();
        
        globalItems = rows.map(row => {
            const roleField = row.c[0]?.v || ""; // Col 0: 角色識別字 (吉, 八, 兔...)
            const type = row.c[1]?.v || "其他";  // Col 1: 分類
            const itemName = row.c[3]?.v || "";  // Col 3: 商品名稱
            
            // 篩選邏輯：如果 Sheet 的角色欄位不包含此頁面設定的 key，則跳過
            if (!itemName || !roleField.includes(currentConfig.sheetKey)) return null;

            // 決定 Supabase 的 Key (前綴 + 名稱)
            // 優先找 "吉伊小可愛"，如果沒有則找 "小可愛"
            const fullKey = currentConfig.sbPrefix + itemName;
            const shortKey = itemName;
            
            let sbData = null;
            let finalKey = shortKey;

            if (supabaseOverrides[fullKey]) {
                finalKey = fullKey;
                sbData = supabaseOverrides[fullKey];
            } else if (supabaseOverrides[shortKey]) {
                finalKey = shortKey;
                sbData = supabaseOverrides[shortKey];
            } else {
                // 如果都沒有，預設 key 使用 fullKey 以便未來儲存時加上前綴
                finalKey = fullKey;
            }

            tempCats.add(type);

            return {
                dbKey: finalKey,         // 用於儲存的唯一 Key
                name: itemName,          // 顯示名稱 (不含前綴)
                type: type,
                price: sbData?.price || "", // 若無覆蓋則為空
                status: sbData?.status || "現貨",
                img: row.c[11]?.v || "https://i.postimg.cc/bv5xRs04/image.png" // Col 11: 圖片
            };
        }).filter(i => i !== null);

        allCategories = Array.from(tempCats);

        // D. 渲染介面
        document.getElementById("loading-msg").style.display = 'none';
        renderAdminToggles();
        renderCards();

        // E. 將分類資料傳回父層，讓父層生成 Sticky Nav 
        sendCategoriesToParent();

    } catch (e) {
        console.error(e);
        document.querySelector("#loading-msg div").innerText = "載入失敗，請稍後重試";
    }
}

// --- 渲染 Admin 分類開關 ---
function renderAdminToggles() {
    const container = document.getElementById("category-toggles");
    if (!isAdmin) return;
    
    container.innerHTML = allCategories.map(cat => `
        <label class="category-checkbox">
          <input type="checkbox" ${visibleCategories.includes(cat) ? 'checked' : ''} onchange="updateVisibleList('${cat}', this.checked)"> ${cat}
        </label>
    `).join("");
}

function updateVisibleList(cat, isChecked) {
    if (isChecked) {
        if(!visibleCategories.includes(cat)) visibleCategories.push(cat);
    } else {
        visibleCategories = visibleCategories.filter(c => c !== cat);
    }
    // 更新顯示但不儲存，直到按儲存按鈕
}

// --- 渲染商品卡片 ---
function renderCards() {
    const container = document.getElementById("card-container");
    container.innerHTML = "";

    // 決定要顯示哪些分類 (Admin 顯示全部，使用者只顯示 visibleCategories)
    const catsToDisplay = isAdmin ? allCategories : allCategories.filter(c => visibleCategories.includes(c));

    // 如果是用戶模式，每次渲染都更新父層 Nav，確保同步
    if(!isAdmin) sendCategoriesToParent(catsToDisplay);

    catsToDisplay.forEach(cat => {
        const items = globalItems.filter(i => i.type === cat);
        // Admin 顯示所有商品，使用者隱藏 "(不顯示)" 的狀態
        const filteredItems = isAdmin ? items : items.filter(i => !i.status.includes("不顯示"));

        if (filteredItems.length === 0) return;

        // 建立分類標題與批量修改器 
        let bulkHTML = "";
        if (isAdmin) {
            const opts = ["現貨", "需預訂", "搭飛機中", "補貨（不顯示）", "已售（不顯示）"];
            bulkHTML = `
            <div class="bulk-wrapper">
                批量:
                <select class="bulk-select" onchange="handleBulkUpdate('${cat}', this.value)">
                    <option value="">選擇狀態...</option>
                    ${opts.map(o => `<option value="${o}">${o}</option>`).join("")}
                </select>
            </div>`;
        }

        const section = document.createElement("div");
        section.id = `cat-${cat}`;
        section.className = "category-section";
        section.innerHTML = `<div class="category-title"><span>${cat}</span> ${bulkHTML}</div>`;

        const grid = document.createElement("div");
        grid.className = "group-grid";

        filteredItems.forEach(item => {
            // 合併暫存的修改 (Pending Changes) 
            let displayItem = { ...item };
            if (pendingChanges[item.dbKey]) {
                if (pendingChanges[item.dbKey].status) displayItem.status = pendingChanges[item.dbKey].status;
                if (pendingChanges[item.dbKey].price) displayItem.price = pendingChanges[item.dbKey].price;
            }

            const card = document.createElement("div");
            card.className = "card";

            // 價格顯示邏輯
            const displayPrice = (displayItem.status === "需預訂" || !displayItem.price) ? 'WhatsApp 查詢' : 'HK$' + displayItem.price;

            card.innerHTML = `
                <img src="${displayItem.img}" loading="lazy">
                <div style="min-height:25px;">
                  ${isAdmin ? renderAdminSelect(displayItem) : `<span class="status-badge" style="background:${getStatusBg(displayItem.status)}">${displayItem.status}</span>`}
                </div>
                <div class="name">${displayItem.name}</div>
                <div class="price">${isAdmin ? renderAdminPrice(displayItem) : displayPrice}</div>
            `;

            // 點擊事件：通知父層打開 Modal 
            card.onclick = (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    // 將商品資料傳給父層，父層負責顯示 Modal 和處理購物車
                    window.parent.postMessage({ type: 'openModal', item: displayItem }, '*');
                }
            };

            grid.appendChild(card);
        });

        section.appendChild(grid);
        container.appendChild(section);
    });

    // 渲染完成後通知父層調整高度 
    setTimeout(sendHeight, 100);
}

// --- Admin 輔助功能 ---
function getStatusBg(s) {
  if(s==="現貨") return "#FFF4BD";
  if(s==="需預訂") return "#D4BBDD";
  if(s==="搭飛機中") return "#C1E1C1";
  if(s.includes("不顯示")) return "#EEEEEE";
  return "#E7F2F8";
}

function renderAdminSelect(item) {
  const opts = ["現貨", "需預訂", "搭飛機中", "補貨（不顯示）", "已售（不顯示）"];
  // onclick stopPropagation 防止觸發卡片點擊
  return `<select class="admin-select" onclick="event.stopPropagation()" onchange="stageChange('${item.dbKey}', 'status', this.value)">
    ${opts.map(opt => `<option value="${opt}" ${item.status === opt ? "selected" : ""}>${opt}</option>`).join("")}
  </select>`;
}

function renderAdminPrice(item) {
  return `<input type="text" class="admin-price-input" value="${item.price}" onclick="event.stopPropagation()" onchange="stageChange('${item.dbKey}', 'price', this.value)">`;
}

// 暫存修改 (尚未寫入 DB) 
function stageChange(key, field, value) {
  if (!pendingChanges[key]) {
    const original = globalItems.find(i => i.dbKey === key);
    pendingChanges[key] = { status: original.status, price: original.price };
  }
  pendingChanges[key][field] = value;
}

// 批量修改邏輯 
function handleBulkUpdate(cat, newStatus) {
    if (!newStatus) return;
    if (!confirm(`確定將「${cat}」下的所有商品狀態修改為「${newStatus}」嗎？\n(注意：需點擊上方「儲存」按鈕才會寫入系統)`)) {
        renderCards(); // 重繪以重置選單
        return;
    }
    const itemsInCat = globalItems.filter(i => i.type === cat);
    itemsInCat.forEach(item => {
        stageChange(item.dbKey, 'status', newStatus);
    });
    renderCards();
}

// --- 儲存至 Supabase ---
async function handleSaveConfig() {
  if (!confirm("確定要儲存分類顯示設定與商品修改嗎？")) return;
  
  // 顯示 Loading 狀態 (簡單版)
  const saveBtn = document.querySelector('.btn-save');
  const originalText = saveBtn.innerText;
  saveBtn.innerText = "儲存中...";
  saveBtn.disabled = true;

  try {
    // 1. 儲存分類設定 (寫入對應的 config key)
    const { error: confErr } = await sbClient.from('chiikawa_config').upsert({ 
      config_key: currentConfig.configKey, 
      config_value: visibleCategories,
      updated_at: new Date().toISOString()
    }, { onConflict: 'config_key' });
    
    if (confErr) throw confErr;

    // 2. 儲存商品修改
    const updates = Object.keys(pendingChanges).map(k => ({ 
      item_name: k, 
      status: pendingChanges[k].status, 
      price: pendingChanges[k].price,
      updated_at: new Date().toISOString()
    }));

    if (updates.length > 0) {
      const { error: itemErr } = await sbClient.from('chiikawa_data').upsert(updates, { onConflict: 'item_name' });
      if (itemErr) throw itemErr;
    }

    alert("儲存成功！");
    pendingChanges = {}; 
    await loadData(); // 重新載入以確認資料

  } catch (e) {  
    console.error(e);
    alert("儲存失敗：" + e.message);
  } finally {
    saveBtn.innerText = originalText;
    saveBtn.disabled = false;
  }
}

// --- 與父層通訊輔助 ---
function sendCategoriesToParent(list = null) {
    // 若未指定 list，則送出目前所有分類 (Admin) 或目前可見分類 (User)
    const data = list || (isAdmin ? allCategories : allCategories.filter(c => visibleCategories.includes(c)));
    window.parent.postMessage({ type: 'categories', data: data }, '*');
}

function sendHeight() {
    // 加入一點緩衝高度
    window.parent.postMessage({ height: document.body.scrollHeight + 20 }, '*');
}

// 監聽 Resize 以調整 iframe 高度 
window.addEventListener('resize', sendHeight);
window.addEventListener('load', sendHeight);

// 啟動程式
init();

</script>
</body>
</html>