<!DOCTYPE html>
<html lang="zh-Hk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chiikawa Child Page</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* 預設 CSS 變數 */
    :root { --tab-color: #d77485; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f9f9f9; 
      margin: 0; padding: 0; color: #333; 
      text-align: center; padding-bottom: 80px; overflow-x: hidden;
    }

    /* Loading 動畫 */
    .loading-container {
      margin-top: 100px;
      position: relative; z-index: 10;
    }
    .loading-icon {
      width: 20%; max-width: 100px; height: auto;
      margin-bottom: 10px;
      animation: bounce 0.8s infinite ease-in-out;
    }
    @keyframes bounce { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-10px); } 
    }

    /* Admin 面板 */
    .admin-panel {
      display: none; background: #fff; padding: 15px; margin: 10px;
      border: 2px dashed var(--tab-color); border-radius: 12px; text-align: left;
    }
    .admin-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .category-checkbox { margin: 5px 15px 5px 0; font-size: 14px; display: inline-flex; align-items: center; cursor: pointer; }
    
    .btn-save, .btn-cancel { padding: 5px 15px; border-radius: 15px; border: none; font-size: 12px; cursor: pointer; color: #fff; font-weight: bold; }
    .btn-save { background: var(--tab-color); opacity: 0.9; }
    .btn-cancel { background: #999; margin-right: 5px; }

    /* 佈局 */
    #card-container { max-width: 1200px; margin: 0 auto; min-height: 50vh; padding: 10px; }
    .category-section { margin-top: 30px; text-align: left; scroll-margin-top: 70px; }
    .category-title { 
      font-size: 18px; font-weight: bold; margin-bottom: 15px; padding-left: 10px;
      border-left: 5px solid var(--tab-color); color: #444;
      display: flex; align-items: center; justify-content: space-between;
    }
    .group-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px; justify-items: center; width: 100%;
    }

    /* 卡片樣式 */
    .card {
      width: 100%; max-width: 130px; border: 1px solid #eee; border-radius: 12px;
      background: #fff; position: relative; text-align: center; padding-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; overflow: hidden; transition: transform 0.2s;
    }
    .card:active { transform: scale(0.98); }
    .card img { width: 100%; aspect-ratio: 1; object-fit: contain; padding: 8px; box-sizing: border-box; }
    .card .name { margin: 4px 6px; font-size: 12px; font-weight: 600; line-height: 1.4; min-height: 32px; display: flex; align-items: center; justify-content: center; }
    .card .price { font-size: 13px; color: var(--tab-color); font-weight: bold; margin-bottom: 6px; }
    .status-badge { display: inline-block; border-radius: 20px; padding: 3px 8px; font-size: 11px; font-weight: 600; margin-bottom: 6px; }

    .admin-select { border: 1px solid #ccc; border-radius: 20px; padding: 2px 5px; font-size: 11px; margin-bottom: 5px; width: 90%; }
    .admin-price-input { width: 80%; border: 1px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; padding: 2px 0; }
    .bulk-wrapper { font-size: 12px; font-weight: normal; color: #666; display: flex; align-items: center; gap: 5px; }
    .bulk-select { padding: 2px 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; }
  </style>
</head>
<body>

  <div id="adminPanel" class="admin-panel">
    <div class="admin-controls">
        <span style="color: var(--tab-color); font-weight: bold;">分類顯示設定</span>
        <div>
            <button class="btn-cancel" onclick="location.reload()">取消</button>
            <button class="btn-save" onclick="handleSaveConfig()">儲存變更</button>
        </div>
    </div>
    <div id="category-toggles"></div>
  </div>

  <div id="loading-msg" class="loading-container">
    <img id="loading-img" src="" alt="Loading" class="loading-icon" />
    <div>資料讀取中...</div>
  </div>

  <div id="card-container"></div>

<script>
// --- Config ---
const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi'; 
const SHEET_ID  = "17mM70ixlZ8LbjDEhfAIi7QdDGMP4T4Le";

let sbClient = (window.supabase) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

const ROLE_CONFIGS = {
    "chii":   { name: "吉伊", sheetName: "吉伊", sbPrefix: "吉伊", configKey: "visible_categories_chii", color: "#d77485", loadImg: "https://i.postimg.cc/ncqjRJ9S/icon001.png" },
    "hachi":  { name: "小八", sheetName: "小八", sbPrefix: "小八", configKey: "visible_categories_hachi", color: "#6293b8", loadImg: "https://i.postimg.cc/Ss5kqJ3L/icon002.png" },
    "usagi":  { name: "兔兔", sheetName: "兔兔", sbPrefix: "兔兔", configKey: "visible_categories", color: "#f9be3c", loadImg: "https://i.postimg.cc/QdbBDJbp/icon003.png" },
    "momo":   { name: "小桃", sheetName: "小桃", sbPrefix: "小桃", configKey: "visible_categories_others", color: "#838BC2", loadImg: "https://i.postimg.cc/rwcd7PSV/icon016.png" },
    "master": { name: "師傅", sheetName: "師傅", sbPrefix: "師傅", configKey: "visible_categories_others", color: "#CCAFA5", loadImg: "https://i.postimg.cc/y8vNtY1j/icon005.png" },
    "kuri":   { name: "栗子", sheetName: "栗子", sbPrefix: "栗子", configKey: "visible_categories_kuri", color: "#94C973", loadImg: "https://i.postimg.cc/mD0kjXLG/icon006.png" },
    "shisa":  { name: "風獅", sheetName: "獅薩", sbPrefix: "風獅", configKey: "visible_categories_shisa", color: "#FBAA60", loadImg: "https://i.postimg.cc/Ghn9s5gF/icon007.png" },
    "furu":   { name: "古本", sheetName: "古本", sbPrefix: "古本", configKey: "visible_categories_others", color: "#eb9e97", loadImg: "https://i.postimg.cc/2jsL76yB/icon008.png" },
    "others": { name: "其他", sheetName: "其他角色", sbPrefix: "其他", configKey: "visible_categories_others", color: "#45818e", loadImg: "https://i.postimg.cc/PqVPpf0J/icon009.png" }
};

let currentRole = "chii", currentConfig = ROLE_CONFIGS["chii"], isAdmin = false;
let globalItems = [], allCategories = [], visibleCategories = ["吊娃", "娃"];
let supabaseOverrides = {}, pendingChanges = {};

function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const roleParam = urlParams.get('role');
    if (roleParam && ROLE_CONFIGS[roleParam]) {
        currentRole = roleParam;
        currentConfig = ROLE_CONFIGS[roleParam];
    }
    document.documentElement.style.setProperty('--tab-color', currentConfig.color);
    document.getElementById("loading-img").src = currentConfig.loadImg;
    loadData();
    window.parent.postMessage({ type: 'childReady' }, '*');
}

window.addEventListener('message', function(e) {
    if (!e.data) return;
    if (e.data.type === 'adminState') { isAdmin = e.data.isAdmin; toggleAdminUI(); renderCards(); }
    if (e.data.type === 'scrollTo') {
        const el = document.getElementById(`cat-${e.data.category}`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    if (e.data.type === 'triggerSave') handleSaveConfig();
    if (e.data.type === 'triggerCancel') location.reload();
});

function toggleAdminUI() {
    const panel = document.getElementById("adminPanel");
    panel.style.display = isAdmin ? "block" : "none";
    if (isAdmin) renderAdminToggles();
}

/**
 * 解決 Supabase 1000 筆限制的遞迴抓取函式
 */
async function fetchAllSupabaseData(tableName) {
    let allData = [];
    let from = 0;
    let step = 1000;
    let hasMore = true;

    while (hasMore) {
        const { data, error } = await sbClient
            .from(tableName)
            .select('*')
            .range(from, from + step - 1);
        
        if (error) {
            console.error("Supabase fetch error:", error);
            break;
        }

        if (data && data.length > 0) {
            allData = allData.concat(data);
            from += step;
            if (data.length < step) hasMore = false;
        } else {
            hasMore = false;
        }
    }
    return allData;
}

async function loadData() {
    try {
        supabaseOverrides = {};
        if (sbClient) {
            // 抓取 Config
            const { data: config } = await sbClient.from('chiikawa_config').select('config_value').eq('config_key', currentConfig.configKey).single();
            if (config?.config_value) visibleCategories = Array.isArray(config.config_value) ? config.config_value : JSON.parse(config.config_value);
            
            // 修正點：使用 fetchAllSupabaseData 解決 1000 筆限制
            const items = await fetchAllSupabaseData('chiikawa_data');
            items.forEach(row => { supabaseOverrides[row.item_name] = row; });
        }

        const sheetRes = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx:out:json&sheet=${encodeURIComponent(currentConfig.sheetName)}`).then(r => r.text());
        const json = JSON.parse(sheetRes.substr(47).slice(0, -2));
        
        const rows = (json.table.rows || []).slice(1);

        const tempCats = new Set();
        globalItems = rows.map(row => {
            const type = row.c[0]?.v || "其他";  
            const itemName = row.c[7]?.v || "";  
            const imgUrl = row.c[3]?.v || "https://i.postimg.cc/bv5xRs04/image.png";
            
            if (!itemName) return null;
            const fullKey = currentConfig.sbPrefix + itemName;
            
            // 這裡現在能確保對應到 1000 筆之後的資料
            let sbData = supabaseOverrides[fullKey] || null;
            tempCats.add(type);
            
            return {
                dbKey: fullKey, name: itemName, type: type,
                price: sbData?.price || "", status: sbData?.status || "現貨", img: imgUrl
            };
        }).filter(i => i !== null);

        allCategories = Array.from(tempCats);
        document.getElementById("loading-msg").style.display = 'none';
        renderAdminToggles();
        renderCards();
        sendCategoriesToParent();
    } catch (e) {
        console.error(e);
        document.querySelector("#loading-msg div").innerText = "載入失敗";
    }
}

function renderAdminToggles() {
    const container = document.getElementById("category-toggles");
    if (!isAdmin) return;
    container.innerHTML = allCategories.map(cat => `
        <label class="category-checkbox">
          <input type="checkbox" ${visibleCategories.includes(cat) ? 'checked' : ''} onchange="updateVisibleList('${cat}', this.checked)"> ${cat}
        </label>
    `).join("");
}

function updateVisibleList(cat, isChecked) {
    if (isChecked) { if(!visibleCategories.includes(cat)) visibleCategories.push(cat); }
    else { visibleCategories = visibleCategories.filter(c => c !== cat); }
}

function renderCards() {
    const container = document.getElementById("card-container");
    container.innerHTML = ""; 
    const catsToDisplay = isAdmin ? allCategories : allCategories.filter(c => visibleCategories.includes(c));
    if(!isAdmin) sendCategoriesToParent(catsToDisplay);

    catsToDisplay.forEach(cat => {
        const items = globalItems.filter(i => i.type === cat);
        const filteredItems = isAdmin ? items : items.filter(i => !i.status.includes("不顯示"));
        if (filteredItems.length === 0) return;

        let bulkHTML = isAdmin ? `
            <div class="bulk-wrapper">批量:
                <select class="bulk-select" onchange="handleBulkUpdate('${cat}', this.value)">
                    <option value="">選擇...</option>
                    <option value="現貨">現貨</option>
                    <option value="需預訂">需預訂</option>
                    <option value="搭飛機中">搭飛機中</option>
                    <option value="補貨（不顯示）">補貨（不顯示）</option>
                    <option value="已售（不顯示）">已售（不顯示）</option>
                </select>
            </div>` : "";

        const section = document.createElement("div");
        section.id = `cat-${cat}`; section.className = "category-section";
        section.innerHTML = `<div class="category-title"><span>${cat}</span> ${bulkHTML}</div>`;
        const grid = document.createElement("div"); grid.className = "group-grid";

        filteredItems.forEach(item => {
            let d = { ...item, ...(pendingChanges[item.dbKey] || {}) };
            const card = document.createElement("div"); card.className = "card";
            const pText = (d.status === "需預訂" || !d.price) ? 'WhatsApp 查詢' : 'HK$' + d.price;

            card.innerHTML = `
                <img src="${d.img}" loading="lazy">
                <div style="min-height:25px;">
                  ${isAdmin ? renderAdminSelect(d) : `<span class="status-badge" style="background:${getStatusBg(d.status)}">${d.status}</span>`}
                </div>
                <div class="name">${d.name}</div>
                <div class="price">${isAdmin ? renderAdminPrice(d) : pText}</div>
            `;
            card.onclick = (e) => { if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') window.parent.postMessage({ type: 'openModal', item: d }, '*'); };
            grid.appendChild(card);
        });
        section.appendChild(grid); container.appendChild(section);
    });
    setTimeout(sendHeight, 150);
}

function getStatusBg(s) {
    if(s==="現貨") return "#FFF4BD"; if(s==="需預訂") return "#D4BBDD";
    if(s==="搭飛機中") return "#C1E1C1"; return "#EEEEEE";
}

function renderAdminSelect(item) {
    const opts = ["現貨", "需預訂", "搭飛機中", "補貨（不顯示）", "已售（不顯示）"];
    return `<select class="admin-select" onclick="event.stopPropagation()" onchange="stageChange('${item.dbKey}', 'status', this.value)">
        ${opts.map(opt => `<option value="${opt}" ${item.status === opt ? "selected" : ""}>${opt}</option>`).join("")}
    </select>`;
}

function renderAdminPrice(item) {
    return `<input type="text" class="admin-price-input" value="${item.price}" onclick="event.stopPropagation()" onchange="stageChange('${item.dbKey}', 'price', this.value)">`;
}

function stageChange(key, field, value) {
    if (!pendingChanges[key]) {
        const ori = globalItems.find(i => i.dbKey === key);
        pendingChanges[key] = { status: ori.status, price: ori.price };
    }
    pendingChanges[key][field] = value;
}

function handleBulkUpdate(cat, newStatus) {
    if (!newStatus || !confirm(`將「${cat}」全部改為「${newStatus}」？`)) return;
    globalItems.filter(i => i.type === cat).forEach(item => stageChange(item.dbKey, 'status', newStatus));
    renderCards();
}

async function handleSaveConfig() {
    if (!confirm("確定儲存？")) return;
    try {
        await sbClient.from('chiikawa_config').upsert({ config_key: currentConfig.configKey, config_value: visibleCategories, updated_at: new Date().toISOString() }, { onConflict: 'config_key' });
        const updates = Object.keys(pendingChanges).map(k => ({ item_name: k, status: pendingChanges[k].status, price: pendingChanges[k].price, updated_at: new Date().toISOString() }));
        if (updates.length > 0) await sbClient.from('chiikawa_data').upsert(updates, { onConflict: 'item_name' });
        alert("儲存成功！"); pendingChanges = {}; await loadData();
    } catch (e) { alert("儲存失敗：" + e.message); }
}

function sendCategoriesToParent(list = null) {
    const data = list || (isAdmin ? allCategories : allCategories.filter(c => visibleCategories.includes(c)));
    window.parent.postMessage({ type: 'categories', data: data }, '*');
}

function sendHeight() { window.parent.postMessage({ height: document.body.scrollHeight + 20 }, '*'); }
window.addEventListener('resize', sendHeight);
init();

</script>
</body>
</html>